<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Materials Master Data - Janstro IMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/css/main-complete.css" rel="stylesheet">
</head>
<body>
    <button class="mobile-menu-toggle" aria-label="Toggle menu">
        <i class="bi bi-list"></i>
    </button>

    <div id="sidebarContainer"></div>

    <main class="main-content" id="main-content">
        <header class="page-header">
            <h1>
                <i class="bi bi-box-seam"></i>
                Materials Master Data
                <span id="filterBadge"></span>
            </h1>
            <p class="text-muted">Manage material specifications, pricing, and categories (Master Data only - Stock levels shown separately)</p>
        </header>

        <!-- Action Bar -->
        <div class="d-flex justify-content-between align-items-center mb-4 gap-3 flex-wrap">
            <div class="d-flex gap-2 flex-wrap">
                <button id="btnAddItem" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i>
                    Add Material
                </button>
                <a href="inventory.html" class="btn btn-success">
                    <i class="bi bi-boxes"></i>
                    View Inventory
                </a>
                <button id="btnRefresh" class="btn btn-secondary">
                    <i class="bi bi-arrow-clockwise"></i>
                    Refresh
                </button>
                <button id="btnShowAll" class="btn btn-outline-primary" style="display: none;">
                    <i class="bi bi-x-circle"></i>
                    Show All
                </button>
                <button id="btnFilterLowStock" class="btn btn-outline-warning">
                    <i class="bi bi-funnel"></i>
                    Low Stock Only
                </button>
            </div>
            <input type="search" id="searchInput" class="form-control" 
                   placeholder="Search materials, SKU..." style="max-width: 300px;">
        </div>

        <!-- Materials Table -->
        <section class="card">
            <div class="card-header">
                <h2 class="h5 mb-0">
                    <i class="bi bi-table"></i>
                    Materials Catalog
                    <span id="itemCount" class="badge bg-primary ms-2">0</span>
                </h2>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Material Name</th>
                                <th>Category</th>
                                <th>Unit</th>
                                <th>Current Stock</th>
                                <th>Reorder Level</th>
                                <th>Unit Price (‚Ç±)</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="materialsTableBody">
                            <tr>
                                <td colspan="9" class="text-center py-5">
                                    <div class="spinner-border text-primary"></div>
                                    <p class="mt-2 text-muted">Loading materials...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- Add/Edit Material Modal -->
    <div class="modal fade" id="materialModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="materialModalLabel">Add Material</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="materialForm">
                    <div class="modal-body">
                        <input type="hidden" id="itemId">
                        
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="itemName" class="form-label">
                                    Material Name <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="itemName" required 
                                       placeholder="e.g., 250W Monocrystalline Solar Panel">
                                <div class="form-text">Full product name/description</div>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label for="sku" class="form-label">
                                    SKU <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="sku" required 
                                       placeholder="e.g., SP-MONO-250">
                                <div class="form-text">Unique identifier</div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="categoryId" class="form-label">
                                    Category <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="categoryId" required>
                                    <option value="">Loading categories...</option>
                                </select>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="unit" class="form-label">
                                    Unit of Measure <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="unit" required>
                                    <option value="pcs">Pieces (pcs)</option>
                                    <option value="box">Box</option>
                                    <option value="set">Set</option>
                                    <option value="meter">Meter (m)</option>
                                    <option value="kg">Kilogram (kg)</option>
                                    <option value="liter">Liter (L)</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Current Stock (Edit Mode - Read-Only) -->
                            <div class="col-md-4 mb-3" id="currentStockField" style="display: none;">
                                <label class="form-label">Current Stock (Read-Only)</label>
                                <input type="text" class="form-control readonly-field" id="currentStock" readonly disabled>
                                <div class="form-text">
                                    <a href="inventory.html" target="_blank">View in Inventory</a> | 
                                    <a href="goods-receipt.html" target="_blank">Add Stock (MIGO)</a>
                                </div>
                            </div>

                            <!-- Initial Stock (Create Mode Only) -->
                            <div class="col-md-4 mb-3" id="initialStockField">
                                <label for="initialQuantity" class="form-label">Initial Stock (Optional)</label>
                                <input type="number" class="form-control" id="initialQuantity" min="0" value="0">
                                <div class="form-text">For new materials only. Use Goods Receipt for existing items.</div>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label for="reorderLevel" class="form-label">
                                    Reorder Level <span class="text-danger">*</span>
                                </label>
                                <input type="number" class="form-control" id="reorderLevel" min="1" required value="10">
                                <div class="form-text">Alert threshold</div>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label for="unitPrice" class="form-label">
                                    Unit Price (‚Ç±) <span class="text-danger">*</span>
                                </label>
                                <input type="number" class="form-control" id="unitPrice" step="0.01" min="0" required>
                                <div class="form-text">Per unit cost</div>
                            </div>
                        </div>

                        <div class="alert alert-info mt-3">
                            <i class="bi bi-info-circle"></i>
                            <strong>ERP Compliance:</strong> This form manages master data only.
                            <ul class="mb-0 mt-2">
                                <li>Stock levels are calculated from transactions (not directly editable)</li>
                                <li>Use <strong>Goods Receipt (MIGO)</strong> to increase stock</li>
                                <li>Use <strong>Invoice (VF01)</strong> to decrease stock</li>
                                <li>View real-time stock in <a href="inventory.html" target="_blank">Inventory Overview</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i>
                            Save Material
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Confirm Deletion</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this material?</p>
                    <p class="fw-bold" id="deleteItemName"></p>
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Warning:</strong> If this material has transaction history, it will be deactivated instead of deleted.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="btnConfirmDelete">
                        <i class="bi bi-trash"></i>
                        Delete Material
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/error-handler.js"></script>
    <script src="assets/js/utils.js"></script>
    <script src="assets/js/api-client.js"></script>
    <script src="assets/js/rbac.js"></script>
    <script src="assets/js/accessibility-fix.js"></script>
    <script src="assets/js/app-core.js"></script>
    <script>
        (async function() {
            let currentItems = [];
            let allItems = [];
            let categories = [];
            let itemToDelete = null;
            let activeFilter = null;

            const tbody = document.getElementById('materialsTableBody');
            const searchInput = document.getElementById('searchInput');
            const materialModal = new bootstrap.Modal(document.getElementById('materialModal'));
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            const materialForm = document.getElementById('materialForm');

            const urlParams = new URLSearchParams(window.location.search);
            const statusFilterFromURL = urlParams.get('filter');

            /**
             * Load all materials from API
             */
            async function loadMaterials() {
                try {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center py-5">
                                <div class="spinner-border text-primary"></div>
                                <p class="mt-2 text-muted">Loading materials...</p>
                            </td>
                        </tr>
                    `;
                    
                    const response = await API.getInventory();
                    
                    let items = [];
                    if (Array.isArray(response)) {
                        items = response;
                    } else if (response?.data && Array.isArray(response.data)) {
                        items = response.data;
                    } else if (response?.success && Array.isArray(response.data)) {
                        items = response.data;
                    }
                    
                    allItems = items;
                    currentItems = [...allItems];
                    
                    if (activeFilter === 'lowstock') {
                        applyLowStockFilter();
                    } else {
                        renderTable(currentItems);
                    }

                    console.log(`‚úÖ Loaded ${items.length} materials`);
                } catch (error) {
                    console.error('‚ùå Load materials error:', error);
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center py-5 text-danger">
                                <i class="bi bi-exclamation-triangle fs-1"></i>
                                <p class="mt-2">Failed to load materials</p>
                                <button class="btn btn-sm btn-primary" onclick="loadMaterials()">
                                    <i class="bi bi-arrow-clockwise"></i>
                                    Retry
                                </button>
                            </td>
                        </tr>
                    `;
                }
            }

            /**
             * Load categories for dropdown
             */
            async function loadCategories() {
                try {
                    const response = await API.getCategories();
                    
                    let cats = [];
                    if (Array.isArray(response)) {
                        cats = response;
                    } else if (response?.data && Array.isArray(response.data)) {
                        cats = response.data;
                    }
                    
                    categories = cats;
                    populateCategorySelect();
                    
                    console.log(`‚úÖ Loaded ${cats.length} categories`);
                } catch (error) {
                    console.error('‚ùå Load categories error:', error);
                    Utils.showToast('Failed to load categories', 'error');
                }
            }

            /**
             * Populate category dropdown
             */
            function populateCategorySelect() {
                const select = document.getElementById('categoryId');
                select.innerHTML = '<option value="">Select category</option>';
                
                if (categories.length === 0) {
                    select.innerHTML += '<option value="" disabled>No categories available</option>';
                    return;
                }
                
                categories.forEach(cat => {
                    select.innerHTML += `<option value="${cat.category_id}">${cat.name}</option>`;
                });
            }

            /**
             * Render materials table
             */
            function renderTable(items) {
                if (!items || items.length === 0) {
                    const message = activeFilter === 'lowstock' 
                        ? '‚úÖ No low stock materials found' 
                        : 'No materials found. Click "Add Material" to get started.';
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center py-5 text-muted">
                                <i class="bi bi-inbox fs-1"></i>
                                <p class="mt-2">${message}</p>
                            </td>
                        </tr>
                    `;
                    document.getElementById('itemCount').textContent = '0';
                    return;
                }

                tbody.innerHTML = items.map(item => {
                    const isLowStock = item.quantity <= item.reorder_level;
                    const isCritical = item.quantity === 0;
                    
                    const stockStatus = isCritical
                        ? '<span class="badge bg-danger">Out of Stock</span>'
                        : isLowStock
                        ? '<span class="badge bg-warning">Low Stock</span>'
                        : '<span class="badge bg-success">In Stock</span>';

                    const rowClass = isCritical ? 'critical-stock-row' : isLowStock ? 'low-stock-row' : '';

                    const canEdit = RBAC.can('inventory', 'edit');
                    const canDelete = RBAC.can('inventory', 'delete');

                    const totalValue = (item.quantity * item.unit_price).toFixed(2);

                    return `
                        <tr class="${rowClass}">
                            <td>
                                <code class="text-primary">${item.sku || 'N/A'}</code>
                            </td>
                            <td>
                                <strong>${item.item_name}</strong>
                                <br>
                                <small class="text-muted">Total Value: ‚Ç±${totalValue}</small>
                            </td>
                            <td>
                                <span class="badge bg-secondary">${getCategoryName(item.category_id)}</span>
                            </td>
                            <td>${item.unit}</td>
                            <td class="${isLowStock ? 'text-warning fw-bold' : ''} text-center">
                                ${item.quantity}
                            </td>
                            <td class="text-center">${item.reorder_level}</td>
                            <td class="text-end">‚Ç±${parseFloat(item.unit_price).toFixed(2)}</td>
                            <td>${stockStatus}</td>
                            <td>
                                <div class="d-flex gap-2">
                                    ${canEdit ? `
                                        <button class="btn btn-sm btn-primary" 
                                                onclick="editMaterial(${item.item_id})"
                                                title="Edit material">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                    ` : ''}
                                    ${canDelete ? `
                                        <button class="btn btn-sm btn-danger" 
                                                onclick="deleteMaterial(${item.item_id}, '${item.item_name.replace(/'/g, "\\'")}')"
                                                title="Delete material">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');

                document.getElementById('itemCount').textContent = items.length;
            }

            /**
             * Get category name by ID
             */
            function getCategoryName(categoryId) {
                const cat = categories.find(c => c.category_id == categoryId);
                return cat ? cat.name : 'Uncategorized';
            }

            /**
             * Apply low stock filter
             */
            function applyLowStockFilter() {
                activeFilter = 'lowstock';
                currentItems = allItems.filter(item => item.quantity <= item.reorder_level);
                renderTable(currentItems);
                console.log(`üîç Filtered to ${currentItems.length} low stock materials`);
            }

            /**
             * Clear all filters
             */
            function clearFilters() {
                activeFilter = null;
                currentItems = [...allItems];
                renderTable(currentItems);
                
                document.getElementById('filterBadge').innerHTML = '';
                document.getElementById('btnShowAll').style.display = 'none';
                document.getElementById('btnFilterLowStock').style.display = 'inline-block';
                
                const url = new URL(window.location);
                url.searchParams.delete('filter');
                window.history.replaceState({}, '', url);
            }

            /**
             * Search functionality
             */
            searchInput.addEventListener('input', Utils.debounce((e) => {
                const query = e.target.value.toLowerCase();
                const filtered = currentItems.filter(item => 
                    item.item_name.toLowerCase().includes(query) ||
                    (item.sku && item.sku.toLowerCase().includes(query)) ||
                    (item.category_name && item.category_name.toLowerCase().includes(query))
                );
                renderTable(filtered);
            }, 300));

            /**
             * Filter buttons
             */
            document.getElementById('btnFilterLowStock').addEventListener('click', () => {
                applyLowStockFilter();
                document.getElementById('filterBadge').innerHTML = 
                    '<span class="filter-badge"><i class="bi bi-funnel-fill"></i> Low Stock</span>';
                document.getElementById('btnShowAll').style.display = 'inline-block';
                document.getElementById('btnFilterLowStock').style.display = 'none';
                Utils.showToast('Showing low stock materials only', 'info');
            });

            document.getElementById('btnShowAll').addEventListener('click', () => {
                clearFilters();
                Utils.showToast('Showing all materials', 'success');
            });

            /**
             * Add material button
             */
            document.getElementById('btnAddItem').addEventListener('click', () => {
                if (!RBAC.can('inventory', 'create')) {
                    Utils.showToast('You do not have permission to add materials', 'error');
                    return;
                }
                
                document.getElementById('materialModalLabel').textContent = 'Add Material';
                materialForm.reset();
                document.getElementById('itemId').value = '';
                document.getElementById('initialQuantity').value = '0';
                document.getElementById('reorderLevel').value = '10';
                
                // Show initial stock field, hide current stock
                document.getElementById('currentStockField').style.display = 'none';
                document.getElementById('initialStockField').style.display = 'block';
                
                materialModal.show();
            });

            /**
             * Edit material
             */
            window.editMaterial = async (itemId) => {
                try {
                    const response = await API.getItem(itemId);
                    let item = null;
                    
                    if (response?.data) {
                        item = response.data;
                    } else if (response?.item_id) {
                        item = response;
                    }
                    
                    if (item) {
                        document.getElementById('materialModalLabel').textContent = 'Edit Material';
                        document.getElementById('itemId').value = item.item_id;
                        document.getElementById('itemName').value = item.item_name;
                        document.getElementById('sku').value = item.sku;
                        document.getElementById('categoryId').value = item.category_id;
                        document.getElementById('unit').value = item.unit;
                        document.getElementById('reorderLevel').value = item.reorder_level;
                        document.getElementById('unitPrice').value = item.unit_price;
                        
                        // Show current stock (read-only), hide initial quantity
                        document.getElementById('currentStock').value = `${item.quantity} ${item.unit}`;
                        document.getElementById('currentStockField').style.display = 'block';
                        document.getElementById('initialStockField').style.display = 'none';
                        
                        materialModal.show();
                    }
                } catch (error) {
                    console.error('‚ùå Edit material error:', error);
                    Utils.showToast('Failed to load material details', 'error');
                }
            };

            /**
             * Save material (Create or Update)
             */
            materialForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const itemId = document.getElementById('itemId').value;
                const data = {
                    item_name: document.getElementById('itemName').value,
                    sku: document.getElementById('sku').value,
                    category_id: parseInt(document.getElementById('categoryId').value),
                    unit: document.getElementById('unit').value,
                    reorder_level: parseInt(document.getElementById('reorderLevel').value),
                    unit_price: parseFloat(document.getElementById('unitPrice').value)
                };

                // Only include initial_quantity for NEW items
                if (!itemId) {
                    const initialQty = parseInt(document.getElementById('initialQuantity').value) || 0;
                    if (initialQty > 0) {
                        data.initial_quantity = initialQty;
                    }
                }
                
                // NEVER send 'quantity' field

                // Validation
                if (!data.item_name || !data.sku || !data.category_id || !data.unit) {
                    Utils.showToast('Please fill all required fields', 'error');
                    return;
                }

                if (data.reorder_level <= 0) {
                    Utils.showToast('Reorder level must be greater than 0', 'error');
                    return;
                }

                if (data.unit_price <= 0) {
                    Utils.showToast('Unit price must be greater than 0', 'error');
                    return;
                }

                try {
                    const submitBtn = materialForm.querySelector('button[type="submit"]');
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';

                    const response = itemId ? 
                        await API.updateItem(itemId, data) : 
                        await API.createItem(data);
                    
                    if (response.success || response.item_id) {
                        Utils.showToast(
                            itemId ? 'Material updated successfully' : 'Material created successfully', 
                            'success'
                        );
                        materialModal.hide();
                        await loadMaterials();
                    } else {
                        Utils.showToast(response.message || 'Failed to save material', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Save material error:', error);
                    const errorMsg = error.message && 
                        (error.message.includes('Cannot set quantity') || 
                         error.message.includes('Cannot update quantity'))
                        ? error.message
                        : 'Error saving material';
                    Utils.showToast(errorMsg, 'error');
                } finally {
                    const submitBtn = materialForm.querySelector('button[type="submit"]');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="bi bi-save"></i> Save Material';
                }
            });

            /**
             * Delete material
             */
            window.deleteMaterial = (itemId, itemName) => {
                itemToDelete = itemId;
                document.getElementById('deleteItemName').textContent = itemName;
                deleteModal.show();
            };

            document.getElementById('btnConfirmDelete').addEventListener('click', async () => {
                try {
                    const btn = document.getElementById('btnConfirmDelete');
                    btn.disabled = true;
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Deleting...';

                    const response = await API.deleteItem(itemToDelete);
                    
                    if (response.success) {
                        Utils.showToast('Material deleted successfully', 'success');
                        deleteModal.hide();
                        await loadMaterials();
                    } else {
                        Utils.showToast(response.message || 'Failed to delete material', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Delete material error:', error);
                    Utils.showToast('Error deleting material', 'error');
                } finally {
                    const btn = document.getElementById('btnConfirmDelete');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-trash"></i> Delete Material';
                }
            });

            /**
             * Refresh button
             */
            document.getElementById('btnRefresh').addEventListener('click', async () => {
                Utils.showToast('Refreshing materials...', 'info');
                await loadMaterials();
            });

            /**
             * Initialize page
             */
            await loadCategories();
            await loadMaterials();
            
            if (statusFilterFromURL === 'lowstock') {
                document.getElementById('btnFilterLowStock').click();
            }

            console.log('‚úÖ Materials Master Data page ready (ERP Compliant)');
        })();
    </script>
    <script src="assets/js/app-init.js"></script>
</body>
</html>