<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goods Receipt - Janstro IMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/css/main-complete.css" rel="stylesheet">
</head>
<body>
    <button class="mobile-menu-toggle" aria-label="Toggle navigation menu">
        <i class="bi bi-list"></i>
    </button>

    <div id="sidebarContainer"></div>

    <main class="main-content" id="main-content">
        <header class="page-header">
            <h1>
                <i class="bi bi-box-arrow-in-down" aria-hidden="true"></i>
                Goods Receipt (MIGO)
            </h1>
            <p class="text-muted">Receive supplier deliveries and update inventory</p>
        </header>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <button id="btnRefresh" class="btn btn-secondary" aria-label="Refresh purchase orders">
                <i class="bi bi-arrow-clockwise" aria-hidden="true"></i>
                Refresh
            </button>
        </div>

        <section class="card">
            <div class="card-header">
                <h2 class="h5 mb-0">
                    <i class="bi bi-list-check" aria-hidden="true"></i>
                    Pending Deliveries
                </h2>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" aria-label="Pending purchase orders table">
                        <thead>
                            <tr>
                                <th scope="col">PO #</th>
                                <th scope="col">Date</th>
                                <th scope="col">Supplier</th>
                                <th scope="col">Item</th>
                                <th scope="col">Ordered Qty</th>
                                <th scope="col">Unit</th>
                                <th scope="col">Expected Delivery</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="grTableBody">
                            <tr>
                                <td colspan="8" class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading pending deliveries...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- Receive Goods Modal -->
    <div class="modal fade" id="receiveModal" tabindex="-1" aria-labelledby="receiveModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h3 class="modal-title h5" id="receiveModalLabel">Receive Goods</h3>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="receiveForm">
                    <div class="modal-body">
                        <div id="poDetails" class="alert alert-info mb-3"></div>
                        
                        <div class="mb-3">
                            <label for="receivedQuantity" class="form-label">Received Quantity <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="receivedQuantity" min="1" required>
                            <small class="text-muted">Ordered quantity: <span id="orderedQty"></span></small>
                        </div>

                        <div class="mb-3">
                            <label for="grNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="grNotes" rows="3" placeholder="Delivery condition, packaging notes, etc."></textarea>
                        </div>

                        <div class="alert alert-warning">
                            <i class="bi bi-info-circle" aria-hidden="true"></i>
                            <strong>Note:</strong> This action will immediately update inventory stock levels.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Process Receipt</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/error-handler.js"></script>
    <script src="assets/js/utils.js"></script>
    <script src="assets/js/api-client.js"></script>
    <script src="assets/js/rbac.js"></script>
    <script src="assets/js/accessibility-fix.js"></script>
    <script src="assets/js/app-core.js"></script>
    <script>
        (async function() {
            let pendingPOs = [];
            let selectedPO = null;

            const tbody = document.getElementById('grTableBody');
            const receiveModal = new bootstrap.Modal(document.getElementById('receiveModal'));
            const receiveForm = document.getElementById('receiveForm');

            async function loadPendingPOs() {
    try {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4"><div class="spinner-border text-primary"></div></td></tr>';
        
        const response = await API.getPurchaseOrders();
        
        // Handle multiple response formats
        let pos = [];
        if (Array.isArray(response)) {
            pos = response;
        } else if (response?.data && Array.isArray(response.data)) {
            pos = response.data;
        } else if (response?.success && Array.isArray(response.data)) {
            pos = response.data;
        }
        
        pendingPOs = pos.filter(po => po.status === 'pending' || po.status === 'approved');
        renderTable(pendingPOs);
    } catch (error) {
        console.error('Load pending POs error:', error);
        tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-danger">Failed to load pending deliveries</td></tr>';
    }
}

            function renderTable(pos) {
                if (!pos || pos.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">No pending deliveries</td></tr>';
                    return;
                }

                tbody.innerHTML = pos.map(po => {
                    const canReceive = RBAC.can('purchase_orders', 'receive');
                    const isOverdue = po.expected_delivery_date && new Date(po.expected_delivery_date) < new Date();

                    return `
                        <tr class="${isOverdue ? 'table-warning' : ''}">
                            <td><strong>PO-${String(po.po_id).padStart(5, '0')}</strong></td>
                            <td>${Utils.formatDate(po.po_date)}</td>
                            <td>${po.supplier_name || 'N/A'}</td>
                            <td>${po.item_name || 'N/A'}</td>
                            <td><strong>${po.quantity}</strong></td>
                            <td>${getItemUnit(po.item_id)}</td>
                            <td>
                                ${po.expected_delivery_date ? Utils.formatDate(po.expected_delivery_date) : 'N/A'}
                                ${isOverdue ? '<br><span class="badge bg-warning">Overdue</span>' : ''}
                            </td>
                            <td>
                                ${canReceive ? `<button class="btn btn-sm btn-success" onclick="receiveGoods(${po.po_id})" aria-label="Receive goods for PO ${po.po_id}">
                                    <i class="bi bi-check-circle" aria-hidden="true"></i>
                                    Receive
                                </button>` : '<span class="text-muted">No permission</span>'}
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            function getItemUnit(itemId) {
                return 'pcs';
            }

            window.receiveGoods = (poId) => {
                selectedPO = pendingPOs.find(po => po.po_id === poId);
                if (selectedPO) {
                    document.getElementById('poDetails').innerHTML = `
                        <strong>PO-${String(poId).padStart(5, '0')}</strong><br>
                        Supplier: ${selectedPO.supplier_name}<br>
                        Item: ${selectedPO.item_name}<br>
                        Expected Quantity: ${selectedPO.quantity}
                    `;
                    
                    document.getElementById('orderedQty').textContent = selectedPO.quantity;
                    document.getElementById('receivedQuantity').value = selectedPO.quantity;
                    document.getElementById('receivedQuantity').max = selectedPO.quantity;
                    document.getElementById('grNotes').value = '';
                    
                    receiveModal.show();
                }
            };

            receiveForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const receivedQty = parseInt(document.getElementById('receivedQuantity').value);
                const notes = document.getElementById('grNotes').value;
                
                if (receivedQty > selectedPO.quantity) {
                    Utils.showToast('Received quantity cannot exceed ordered quantity', 'error');
                    return;
                }

                const data = {
                    received_quantity: receivedQty,
                    notes: notes || `Goods received from ${selectedPO.supplier_name}`,
                    user_id: API.getCurrentUserData().user_id
                };

                try {
                    const response = await API.receiveGoods(selectedPO.po_id, data);
                    
                    if (response.success) {
                        Utils.showToast(
                            `Goods received! Stock updated from ${response.previous_stock || 0} to ${response.new_stock_level || 0}`, 
                            'success'
                        );
                        receiveModal.hide();
                        loadPendingPOs();
                    } else {
                        Utils.showToast(response.message || 'Failed to process receipt', 'error');
                    }
                } catch (error) {
                    console.error('Receive goods error:', error);
                    Utils.showToast('Error processing goods receipt', 'error');
                }
            });

            document.getElementById('btnRefresh').addEventListener('click', loadPendingPOs);

            await loadPendingPOs();
        })();
    </script>
    <script src="assets/js/app-init.js"></script>
</body>
</html>