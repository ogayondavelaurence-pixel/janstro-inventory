<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customers - Janstro IMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/css/main-complete.css" rel="stylesheet">
</head>
<body>
    <button class="mobile-menu-toggle" aria-label="Toggle navigation menu">
        <i class="bi bi-list"></i>
    </button>

    <div id="sidebarContainer"></div>

    <main class="main-content" id="main-content">
        <header class="page-header">
            <h1>
                <i class="bi bi-person-lines-fill"></i>
                Customer Master Data
            </h1>
            <p class="text-muted">Manage customer information and order history</p>
        </header>

        <!-- Stats Row -->
        <div class="row g-4 mb-4">
            <div class="col-md-3 col-sm-6">
                <div class="stat-card stat-primary">
                    <div class="stat-icon"><i class="bi bi-people-fill"></i></div>
                    <div class="stat-value" id="statTotal">0</div>
                    <div class="stat-label">Total Customers</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="stat-card stat-success">
                    <div class="stat-icon"><i class="bi bi-person-check"></i></div>
                    <div class="stat-value" id="statIndividual">0</div>
                    <div class="stat-label">Individual</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="stat-card stat-warning">
                    <div class="stat-icon"><i class="bi bi-building"></i></div>
                    <div class="stat-value" id="statCommercial">0</div>
                    <div class="stat-label">Commercial</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="stat-card stat-danger">
                    <div class="stat-icon"><i class="bi bi-bank"></i></div>
                    <div class="stat-value" id="statGovernment">0</div>
                    <div class="stat-label">Government</div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <button id="btnAddCustomer" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i>
                Add Customer
            </button>
            <input type="search" id="searchInput" class="form-control" 
                   placeholder="Search customers..." 
                   aria-label="Search customers" 
                   style="max-width: 300px;">
        </div>

        <section class="card">
            <div class="card-header">
                <h2 class="h5 mb-0">
                    <i class="bi bi-people"></i>
                    Customer List
                </h2>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" aria-label="Customers table">
                        <thead>
                            <tr>
                                <th scope="col">Customer Name</th>
                                <th scope="col">Contact</th>
                                <th scope="col">Email</th>
                                <th scope="col">Type</th>
                                <th scope="col">Source</th>
                                <th scope="col">Total Orders</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customersBody">
                            <tr>
                                <td colspan="7" class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading customers...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- Add/Edit Modal -->
    <div class="modal fade" id="customerModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title h5" id="customerModalLabel">Add Customer</h3>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="customerForm">
                    <div class="modal-body">
                        <input type="hidden" id="customerId">
                        
                        <div class="mb-3">
                            <label for="customerName" class="form-label">
                                Customer Name <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="customerName" required>
                        </div>

                        <div class="mb-3">
                            <label for="contactNumber" class="form-label">
                                Contact Number <span class="text-danger">*</span>
                            </label>
                            <input type="tel" class="form-control" id="contactNumber" 
                                   placeholder="09XXXXXXXXX" required>
                        </div>

                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email">
                        </div>

                        <div class="mb-3">
                            <label for="address" class="form-label">Address</label>
                            <textarea class="form-control" id="address" rows="2"></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="customerType" class="form-label">Customer Type</label>
                            <select class="form-select" id="customerType">
                                <option value="individual">Individual</option>
                                <option value="commercial">Commercial</option>
                                <option value="government">Government</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="source" class="form-label">Source</label>
                            <select class="form-select" id="source">
                                <option value="">-- Select Source --</option>
                                <option value="Facebook">Facebook</option>
                                <option value="Website">Website</option>
                                <option value="Walk-in">Walk-in</option>
                                <option value="Referral">Referral</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="notes" class="form-label">Notes</label>
                            <textarea class="form-control" id="notes" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Save Customer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/error-handler.js"></script>
    <script src="assets/js/utils.js"></script>
    <script src="assets/js/api-client.js"></script>
    <script src="assets/js/rbac.js"></script>
    <script src="assets/js/accessibility-fix.js"></script>
    <script src="assets/js/app-core.js"></script>
    <script>
        (async function() {
            let customerData = [];
            const tbody = document.getElementById('customersBody');
            const customerModal = new bootstrap.Modal(document.getElementById('customerModal'));
            const customerForm = document.getElementById('customerForm');

            // Update stats
            function updateStats(customers) {
                const total = customers.length;
                const individual = customers.filter(c => c.customer_type === 'individual').length;
                const commercial = customers.filter(c => c.customer_type === 'commercial').length;
                const government = customers.filter(c => c.customer_type === 'government').length;

                document.getElementById('statTotal').textContent = total;
                document.getElementById('statIndividual').textContent = individual;
                document.getElementById('statCommercial').textContent = commercial;
                document.getElementById('statGovernment').textContent = government;
            }

            // Load customers
            async function loadCustomers() {
                try {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4"><div class="spinner-border text-primary"></div></td></tr>';
                    
                    // ‚úÖ Use existing API method
                    const response = await API.getCustomers();
                    
                    console.log('üîç Raw response:', response);
                    
                    // Handle multiple response formats
                    let customers = [];
                    if (Array.isArray(response)) {
                        customers = response;
                    } else if (response?.data && Array.isArray(response.data)) {
                        customers = response.data;
                    } else if (response?.success && Array.isArray(response.data)) {
                        customers = response.data;
                    }
                    
                    console.log('üì¶ Customers loaded:', customers.length);
                    customerData = customers;
                    updateStats(customerData);
                    renderTable(customerData);
                } catch (error) {
                    console.error('‚ùå Load customers error:', error);
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-danger">Failed to load customers. Check console.</td></tr>';
                }
            }

            // Render table
            function renderTable(customers) {
                if (!customers || customers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">No customers found. Click "Add Customer" to create one.</td></tr>';
                    return;
                }

                tbody.innerHTML = customers.map(c => `
                    <tr>
                        <td><strong>${c.customer_name}</strong></td>
                        <td>${c.contact_number || 'N/A'}</td>
                        <td>${c.email || 'N/A'}</td>
                        <td>
                            <span class="badge ${
                                c.customer_type === 'individual' ? 'bg-success' :
                                c.customer_type === 'commercial' ? 'bg-warning' :
                                'bg-danger'
                            }">
                                ${c.customer_type}
                            </span>
                        </td>
                        <td><span class="badge bg-info">${c.source || 'N/A'}</span></td>
                        <td>${c.total_orders || 0}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editCustomer(${c.customer_id})" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            // Add customer
            document.getElementById('btnAddCustomer').addEventListener('click', () => {
                document.getElementById('customerModalLabel').textContent = 'Add Customer';
                customerForm.reset();
                document.getElementById('customerId').value = '';
                customerModal.show();
            });

            // Edit customer
            window.editCustomer = async (customerId) => {
                try {
                    // ‚úÖ Use existing API method
                    const response = await API.getCustomer(customerId);
                    const c = response.data || response;
                    
                    document.getElementById('customerModalLabel').textContent = 'Edit Customer';
                    document.getElementById('customerId').value = c.customer_id;
                    document.getElementById('customerName').value = c.customer_name;
                    document.getElementById('contactNumber').value = c.contact_number || '';
                    document.getElementById('email').value = c.email || '';
                    document.getElementById('address').value = c.address || '';
                    document.getElementById('customerType').value = c.customer_type || 'individual';
                    document.getElementById('source').value = c.source || '';
                    document.getElementById('notes').value = c.notes || '';
                    customerModal.show();
                } catch (error) {
                    console.error('‚ùå Edit customer error:', error);
                    Utils.showToast('Failed to load customer', 'error');
                }
            };

            // Save customer
            customerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const customerId = document.getElementById('customerId').value;
                const data = {
                    customer_name: document.getElementById('customerName').value,
                    contact_number: document.getElementById('contactNumber').value,
                    email: document.getElementById('email').value || null,
                    address: document.getElementById('address').value || null,
                    customer_type: document.getElementById('customerType').value,
                    source: document.getElementById('source').value || null,
                    notes: document.getElementById('notes').value || null
                };

                try {
                    let response;
                    if (customerId) {
                        // ‚úÖ Use existing API method for UPDATE
                        response = await API.updateCustomer(customerId, data);
                    } else {
                        // ‚úÖ Use existing API method for CREATE
                        response = await API.createCustomer(data);
                    }
                    
                    if (response.success || response.data) {
                        Utils.showToast(response.message || 'Customer saved successfully', 'success');
                        customerModal.hide();
                        await loadCustomers();
                    } else {
                        Utils.showToast(response.message || 'Failed to save customer', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Save error:', error);
                    Utils.showToast('Error saving customer', 'error');
                }
            });

            // Search
            document.getElementById('searchInput').addEventListener('input', Utils.debounce((e) => {
                const query = e.target.value.toLowerCase();
                const filtered = customerData.filter(c => 
                    c.customer_name.toLowerCase().includes(query) ||
                    (c.contact_number && c.contact_number.includes(query)) ||
                    (c.email && c.email.toLowerCase().includes(query))
                );
                renderTable(filtered);
            }, 300));

            // Initial load
            await loadCustomers();
            console.log('‚úÖ Customers page ready');
        })();
    </script>
    <script src="assets/js/app-init.js"></script>
</body>
</html>