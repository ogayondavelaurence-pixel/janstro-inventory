<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill of Materials - Janstro IMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/css/main-complete.css" rel="stylesheet">
</head>
<body>
    <button class="mobile-menu-toggle" aria-label="Toggle menu">
        <i class="bi bi-list"></i>
    </button>

    <div id="sidebarContainer"></div>

    <main class="main-content">
        <header class="page-header">
            <h1>
                <i class="bi bi-diagram-3"></i>
                Bill of Materials (BOM) v2.0
            </h1>
            <p class="text-muted">Organized by product families with versioning support</p>
        </header>

        <!-- Action Bar -->
        <div class="d-flex justify-content-between align-items-center mb-4 gap-3 flex-wrap">
            <div class="btn-group" role="group">
                <button id="btnCreateBOM" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Create BOM
                </button>
                <button id="btnCreateTemplate" class="btn btn-outline-primary">
                    <i class="bi bi-file-earmark-plus"></i> Create Template
                </button>
                <button id="btnBulkImport" class="btn btn-outline-secondary">
                    <i class="bi bi-file-earmark-arrow-up"></i> Bulk Import
                </button>
            </div>

            <div class="d-flex gap-2">
                <select id="familyFilter" class="form-select" style="width: auto;" aria-label="Filter by Product Family">
                    <option value="">All Families</option>
                </select>
                <button id="btnRefresh" class="btn btn-secondary">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>

        <!-- Product Family Summary Cards -->
        <div id="familySummary" class="row g-3 mb-4"></div>

        <!-- BOM List by Family -->
        <section class="card">
            <div class="card-header">
                <h2 class="h5 mb-0">
                    <i class="bi bi-list-ul"></i>
                    BOM Items
                    <span id="bomCount" class="badge bg-primary ms-2">0</span>
                </h2>
            </div>
            <div class="card-body">
                <div id="bomListContainer">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary"></div>
                        <p class="mt-2 text-muted">Loading BOMs...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Cost Breakdown Chart -->
        <section class="card mt-4">
            <div class="card-header">
                <h2 class="h5 mb-0">
                    <i class="bi bi-graph-up"></i>
                    Component Cost Breakdown
                </h2>
            </div>
            <div class="card-body">
                <canvas id="costBreakdownChart" style="max-height: 400px;"></canvas>
            </div>
        </section>
    </main>

    <!-- Create BOM Modal (Enhanced) -->
    <div class="modal fade" id="createBOMModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create Bill of Materials</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="bomForm">
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label for="parentItemId" class="form-label">Parent Item (Finished Product)</label>
                                <select class="form-select" id="parentItemId" required></select>
                            </div>
                            <div class="col-md-4">
                                <label for="versionNumber" class="form-label">Version</label>
                                <input type="text" class="form-control" id="versionNumber" placeholder="v1.0" value="v1.0">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label for="componentItemId" class="form-label">Component Item</label>
                                <select class="form-select" id="componentItemId" required></select>
                            </div>
                            <div class="col-md-4">
                                <label for="quantityRequired" class="form-label">Quantity Required</label>
                                <input type="number" class="form-control" id="quantityRequired" min="1" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="bomNotes" class="form-label">Notes (Optional)</label>
                            <textarea class="form-control" id="bomNotes" rows="2"></textarea>
                        </div>

                        <div id="stockWarning" class="alert alert-warning d-none"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Create BOM
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- BOM Explosion Modal -->
    <div class="modal fade" id="explosionModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">BOM Explosion Tree</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="explosionTree"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Template Modal -->
    <div class="modal fade" id="templateModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create BOM Template</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="templateForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Template Name</label>
                            <input type="text" class="form-control" id="templateName" required aria-label="Template Name">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="templateDescription" rows="2" aria-label="Template Description"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Product Family</label>
                            <select class="form-select" id="templateFamily" aria-label="Product Family"></select>
                        </div>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            Templates allow you to quickly create BOMs for similar products
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Create Template
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bulk Import Modal -->
    <div class="modal fade" id="bulkImportModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Bulk Import BOM Components</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <strong>CSV Format:</strong> parent_item_id, component_item_id, quantity<br>
                        <small>Example: 1,5,2 means Parent Item #1 needs 2 units of Component #5</small>
                    </div>
                    <label class="form-label">Paste CSV Data:</label>
                    <textarea id="bulkImportData" class="form-control font-monospace" rows="10" aria-label="Paste CSV Data"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="processBulkImport()">
                        <i class="bi bi-upload"></i> Import
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="assets/js/error-handler.js"></script>
    <script src="assets/js/utils.js"></script>
    <script src="assets/js/api-client.js"></script>
    <script src="assets/js/rbac.js"></script>
    <script src="assets/js/accessibility-fix.js"></script>
    <script src="assets/js/app-core.js"></script>

    <script>
     (async function() {
            let allItems = [];
            let allBOMs = [];
            let productFamilies = [];
            let costChart = null;
            let currentFamily = '';

            const createModal = new bootstrap.Modal(document.getElementById('createBOMModal'));
            const explosionModal = new bootstrap.Modal(document.getElementById('explosionModal'));
            const bulkImportModal = new bootstrap.Modal(document.getElementById('bulkImportModal'));
            const templateModal = new bootstrap.Modal(document.getElementById('templateModal'));

            async function loadItems() {
                try {
                    const response = await API.request('inventory');
                    allItems = Array.isArray(response) ? response : (response?.data || []);
                    populateItemDropdowns();
                    console.log(`✅ Loaded ${allItems.length} items`);
                } catch (error) {
                    console.error('Load items error:', error);
                    Utils.showToast('Failed to load items', 'error');
                }
            }

            function populateItemDropdowns() {
                const parentSelect = document.getElementById('parentItemId');
                const componentSelect = document.getElementById('componentItemId');
                const familyFilter = document.getElementById('familyFilter');
                const templateFamily = document.getElementById('templateFamily');

                parentSelect.innerHTML = '<option value="">Select parent item...</option>';
                componentSelect.innerHTML = '<option value="">Select component...</option>';
                
                // Extract unique families
                const families = [...new Set(allItems.map(i => i.product_family).filter(Boolean))];
                productFamilies = families;

                familyFilter.innerHTML = '<option value="">All Families</option>';
                templateFamily.innerHTML = '<option value="">Select family...</option>';
                
                families.forEach(family => {
                    familyFilter.innerHTML += `<option value="${family}">${family}</option>`;
                    templateFamily.innerHTML += `<option value="${family}">${family}</option>`;
                });

                allItems.forEach(item => {
                    const familyLabel = item.product_family ? `[${item.product_family}] ` : '';
                    const option = `<option value="${item.item_id}" data-stock="${item.quantity}">${familyLabel}${item.item_name} (Stock: ${item.quantity})</option>`;
                    parentSelect.innerHTML += option;
                    componentSelect.innerHTML += option;
                });
            }

            async function loadBOMs() {
                try {
                    const container = document.getElementById('bomListContainer');
                    container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';

                    const response = await API.request('bom');
                    const data = response?.data || response;
                    allBOMs = data?.boms || [];

                    renderFamilySummary();
                    renderBOMList(allBOMs);
                    renderCostBreakdown(allBOMs);
                    
                    document.getElementById('bomCount').textContent = allBOMs.length;
                    console.log(`✅ Loaded ${allBOMs.length} BOM items`);
                } catch (error) {
                    console.error('Load BOMs error:', error);
                    document.getElementById('bomListContainer').innerHTML = 
                        '<div class="text-center py-4 text-danger">Failed to load BOMs</div>';
                }
            }

            function renderFamilySummary() {
                const container = document.getElementById('familySummary');
                
                if (!productFamilies || productFamilies.length === 0) {
                    container.innerHTML = '';
                    return;
                }

                const familyStats = {};
                
                allBOMs.forEach(bom => {
                    const parent = allItems.find(i => i.item_id === bom.parent_item_id);
                    const family = parent?.product_family || 'Uncategorized';
                    
                    if (!familyStats[family]) {
                        familyStats[family] = { count: 0, totalValue: 0 };
                    }
                    
                    familyStats[family].count++;
                    familyStats[family].totalValue += bom.components.reduce((sum, c) => sum + c.component_value, 0);
                });

                container.innerHTML = Object.entries(familyStats).map(([family, stats]) => `
                    <div class="col-md-3">
                        <div class="product-family-card card" onclick="filterByFamily('${family}')">
                            <div class="card-body">
                                <h6 class="text-muted mb-1">${family}</h6>
                                <h3 class="mb-0">${stats.count}</h3>
                                <small class="text-muted">Total: ₱${stats.totalValue.toFixed(2)}</small>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            window.filterByFamily = function(family) {
                currentFamily = family;
                const filtered = allBOMs.filter(bom => {
                    const parent = allItems.find(i => i.item_id === bom.parent_item_id);
                    return parent?.product_family === family;
                });
                renderBOMList(filtered);
                Utils.showToast(`Showing ${filtered.length} BOMs in ${family}`, 'info');
            };

            function renderBOMList(boms) {
                const container = document.getElementById('bomListContainer');

                if (!boms || boms.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-5 text-muted">
                            <i class="bi bi-inbox fs-1"></i>
                            <p class="mt-2">No BOMs found. Click "Create BOM" to get started.</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                boms.forEach(bom => {
                    const parent = allItems.find(i => i.item_id === bom.parent_item_id);
                    const familyBadge = parent?.product_family ? 
                        `<span class="badge bg-info">${parent.product_family}</span>` : '';
                    
                    const totalValue = bom.components.reduce((sum, c) => sum + c.component_value, 0);
                    
                    html += `
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">
                                            <i class="bi bi-box-seam text-primary"></i>
                                            <strong>${bom.parent_item_name}</strong>
                                            <code class="text-muted ms-2">${bom.parent_sku}</code>
                                            ${familyBadge}
                                        </h6>
                                        <small class="text-muted">${bom.total_components} components | Total BOM Cost: ₱${totalValue.toFixed(2)}</small>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-info" onclick="viewExplosion(${bom.parent_item_id})" title="BOM Explosion">
                                            <i class="bi bi-diagram-3"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm mb-0">
                                        <thead>
                                            <tr>
                                                <th>Component</th>
                                                <th>SKU</th>
                                                <th>Qty Required</th>
                                                <th>Available Stock</th>
                                                <th>Unit Price</th>
                                                <th>Total Value</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${bom.components.map(comp => `
                                                <tr>
                                                    <td>${comp.component_name}</td>
                                                    <td><code>${comp.component_sku}</code></td>
                                                    <td>${comp.quantity_required} ${comp.unit}</td>
                                                    <td>${comp.available_stock}</td>
                                                    <td>₱${comp.component_price.toFixed(2)}</td>
                                                    <td>₱${comp.component_value.toFixed(2)}</td>
                                                    <td>
                                                        <span class="bom-badge bom-${comp.stock_status}">
                                                            ${comp.stock_status === 'available' ? '✓' : 
                                                              comp.stock_status === 'partial' ? '⚠' : '✗'}
                                                            ${comp.stock_status}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <button class="btn btn-sm btn-danger" onclick="deleteBOMComponent(${comp.bom_id}, '${comp.component_name}')" title="Delete">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
            }

            function renderCostBreakdown(boms) {
                const ctx = document.getElementById('costBreakdownChart');
                if (!ctx) return;

                if (costChart) costChart.destroy();

                if (!boms || boms.length === 0) {
                    ctx.parentElement.innerHTML = '<p class="text-center text-muted py-4">No BOM data available</p>';
                    return;
                }

                const chartData = boms.map(bom => ({
                    parent: bom.parent_item_name,
                    totalCost: bom.components.reduce((sum, c) => sum + c.component_value, 0)
                }));

                costChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chartData.map(d => d.parent),
                        datasets: [{
                            label: 'Total BOM Cost (₱)',
                            data: chartData.map(d => d.totalCost),
                            backgroundColor: '#667eea',
                            borderRadius: 8
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => `Cost: ₱${context.parsed.x.toFixed(2)}`
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) => `₱${value}`
                                }
                            }
                        }
                    }
                });
            }

            window.viewExplosion = async function(parentItemId) {
                try {
                    const response = await API.request(`bom/${parentItemId}/explosion`);
                    const data = response?.data || response;
                    const explosion = data?.explosion_tree || [];

                    const container = document.getElementById('explosionTree');
                    
                    if (explosion.length === 0) {
                        container.innerHTML = '<p class="text-muted">No components found</p>';
                    } else {
                        container.innerHTML = renderExplosionTree(explosion);
                    }

                    explosionModal.show();
                } catch (error) {
                    console.error('BOM explosion error:', error);
                    Utils.showToast('Failed to load BOM explosion', 'error');
                }
            };

            function renderExplosionTree(nodes, level = 0) {
                let html = '';
                nodes.forEach(node => {
                    const statusClass = node.shortage > 0 ? 'text-danger' : 'text-success';
                    const indent = level * 20;
                    
                    html += `
                        <div class="p-3 mb-2 border rounded" style="margin-left: ${indent}px; border-left: 3px solid ${node.shortage > 0 ? '#ef4444' : '#10b981'} !important;">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${node.item_name}</strong>
                                    <code class="ms-2">${node.sku}</code>
                                    <span class="badge bg-secondary ms-2">Level ${node.level}</span>
                                </div>
                                <div class="${statusClass}">
                                    <strong>Required: ${node.total_required}</strong> | 
                                    Available: ${node.available_stock} |
                                    ${node.shortage > 0 ? `<span class="text-danger">⚠ Short: ${node.shortage}</span>` : '✓ OK'}
                                </div>
                            </div>
                        </div>
                    `;

                    if (node.sub_components && node.sub_components.length > 0) {
                        html += renderExplosionTree(node.sub_components, level + 1);
                    }
                });
                return html;
            }

            document.getElementById('btnBulkImport').addEventListener('click', () => {
                document.getElementById('bulkImportData').value = '';
                bulkImportModal.show();
            });

            window.processBulkImport = async function() {
                const csvData = document.getElementById('bulkImportData').value.trim();
                
                if (!csvData) {
                    Utils.showToast('Please paste CSV data', 'error');
                    return;
                }

                const lines = csvData.split('\n').filter(line => line.trim());
                const bomEntries = [];
                const errors = [];

                lines.forEach((line, idx) => {
                    const parts = line.split(',').map(p => p.trim());
                    
                    if (parts.length !== 3) {
                        errors.push(`Line ${idx + 1}: Invalid format`);
                        return;
                    }

                    const [parentId, componentId, quantity] = parts.map(Number);

                    if (isNaN(parentId) || isNaN(componentId) || isNaN(quantity)) {
                        errors.push(`Line ${idx + 1}: Non-numeric values`);
                        return;
                    }

                    if (parentId === componentId) {
                        errors.push(`Line ${idx + 1}: Parent cannot be its own component`);
                        return;
                    }

                    bomEntries.push({ parent_item_id: parentId, component_item_id: componentId, quantity_required: quantity });
                });

                if (errors.length > 0) {
                    Utils.showToast(`${errors.length} errors found. Check console.`, 'error');
                    console.error('Import errors:', errors);
                    return;
                }

                try {
                    let successCount = 0;
                    for (const entry of bomEntries) {
                        try {
                            await API.request('bom', { method: 'POST', body: entry });
                            successCount++;
                        } catch (err) {
                            console.error('Import error:', err);
                        }
                    }

                    Utils.showToast(`Imported ${successCount} of ${bomEntries.length} BOMs`, 'success');
                    bulkImportModal.hide();
                    await loadBOMs();
                } catch (error) {
                    Utils.showToast('Bulk import failed', 'error');
                }
            };

            document.getElementById('btnCreateBOM').addEventListener('click', () => {
                document.getElementById('bomForm').reset();
                document.getElementById('stockWarning').classList.add('d-none');
                createModal.show();
            });

            document.getElementById('btnCreateTemplate').addEventListener('click', () => {
                templateModal.show();
            });

            document.getElementById('componentItemId').addEventListener('change', (e) => {
                const componentId = parseInt(e.target.value);
                const component = allItems.find(i => i.item_id === componentId);
                
                if (component) {
                    const warning = document.getElementById('stockWarning');
                    if (component.quantity <= component.reorder_level) {
                        warning.classList.remove('d-none');
                        warning.textContent = `⚠ Warning: ${component.item_name} has low stock (${component.quantity} available)`;
                    } else {
                        warning.classList.add('d-none');
                    }
                }
            });

            document.getElementById('bomForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const data = {
                    parent_item_id: parseInt(document.getElementById('parentItemId').value),
                    component_item_id: parseInt(document.getElementById('componentItemId').value),
                    quantity_required: parseInt(document.getElementById('quantityRequired').value),
                    notes: document.getElementById('bomNotes').value || null
                };

                if (data.parent_item_id === data.component_item_id) {
                    Utils.showToast('Parent item cannot be its own component', 'error');
                    return;
                }

                try {
                    const btn = e.target.querySelector('button[type="submit"]');
                    btn.disabled = true;
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Creating...';

                    await API.request('bom', { method: 'POST', body: data });
                    Utils.showToast('BOM created successfully', 'success');
                    createModal.hide();
                    await loadBOMs();
                } catch (error) {
                    console.error('Create BOM error:', error);
                    Utils.showToast(error.message || 'Error creating BOM', 'error');
                } finally {
                    const btn = e.target.querySelector('button[type="submit"]');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-save"></i> Create BOM';
                }
            });

            window.deleteBOMComponent = async function(bomId, componentName) {
                if (!confirm(`Delete component "${componentName}" from BOM?`)) return;

                try {
                    await API.request(`bom/${bomId}`, { method: 'DELETE' });
                    Utils.showToast('BOM component deleted successfully', 'success');
                    await loadBOMs();
                } catch (error) {
                    console.error('Delete BOM error:', error);
                    Utils.showToast('Error deleting BOM component', 'error');
                }
            };

            document.getElementById('btnRefresh').addEventListener('click', async () => {
                Utils.showToast('Refreshing...', 'info');
                await Promise.all([loadItems(), loadBOMs()]);
            });

            document.getElementById('familyFilter').addEventListener('change', (e) => {
                const family = e.target.value;
                if (family) {
                    filterByFamily(family);
                } else {
                    renderBOMList(allBOMs);
                }
            });

            await loadItems();
            await loadBOMs();

            console.log('✅ BOM Management v2.0 ready with product family organization');
        })();
    </script>

    <script src="assets/js/app-init.js"></script>
</body>
</html>