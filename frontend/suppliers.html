<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Suppliers - Janstro IMS</title>
  
  <!-- âœ… FIXED: Bootstrap CSS + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  
  <!-- Main CSS -->
  <link rel="stylesheet" href="assets/css/main-complete.css">
</head>
<body>
  <!-- Mobile Menu Toggle -->
  <button class="mobile-menu-toggle" aria-label="Toggle menu">
    <i class="bi bi-list"></i>
  </button>
  
  <!-- Sidebar Container -->
  <div id="sidebarContainer"></div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Page Header -->
    <div class="page-header mb-4">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
        <div>
          <h1 class="mb-2"><i class="bi bi-truck text-info"></i> Supplier Master Data</h1>
          <p class="text-muted mb-0">Vendor information for procurement</p>
        </div>
        <button class="btn btn-primary" onclick="showAddModal()" id="btnAdd" aria-label="Add Supplier">
          <i class="bi bi-plus-circle"></i> Add Supplier
        </button>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-3 mb-4">
      <div class="col-6 col-md-4">
        <div class="card text-center p-3">
          <h3 id="statTotal" class="text-primary mb-1">0</h3>
          <small>Total</small>
        </div>
      </div>
      <div class="col-6 col-md-4">
        <div class="card text-center p-3">
          <h3 id="statActive" class="text-success mb-1">0</h3>
          <small>Active</small>
        </div>
      </div>
      <div class="col-12 col-md-4">
        <div class="card text-center p-3">
          <h3 id="statInactive" class="text-secondary mb-1">0</h3>
          <small>Inactive</small>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-8">
            <label for="searchSupplier" class="visually-hidden">Search Suppliers</label>
            <input type="text" id="searchSupplier" class="form-control" placeholder="ðŸ” Search name, contact..." aria-label="Search Suppliers">
          </div>
          <div class="col-md-2">
            <label for="statusFilter" class="visually-hidden">Filter by Status</label>
            <select id="statusFilter" class="form-control" aria-label="Filter by Status">
              <option value="">All</option>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>
          <div class="col-md-2">
            <button class="btn btn-primary w-100" onclick="loadSuppliers()" aria-label="Reload Suppliers">
              <i class="bi bi-arrow-clockwise"></i> Reload
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Supplier List</h5>
      </div>
      <div id="supplierTable">
        <div class="text-center py-5">
          <div class="spinner-border" role="status" aria-label="Loading"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- âœ… FIXED: Bootstrap Modal (Proper Structure) -->
  <div class="modal fade" id="supplierModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Add Supplier</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="supplierForm" onsubmit="saveSupplier(event)">
          <div class="modal-body">
            <input type="hidden" id="supplierId">
            
            <div class="row g-3">
              <div class="col-md-6">
                <label for="supplierName" class="form-label">Supplier Name <span class="text-danger">*</span></label>
                <input type="text" id="supplierName" class="form-control" required aria-required="true">
              </div>
              <div class="col-md-6">
                <label for="contactPerson" class="form-label">Contact Person</label>
                <input type="text" id="contactPerson" class="form-control">
              </div>
              <div class="col-md-6">
                <label for="supplierPhone" class="form-label">Phone</label>
                <input type="tel" id="supplierPhone" class="form-control" placeholder="09XXXXXXXXX">
              </div>
              <div class="col-md-6">
                <label for="supplierEmail" class="form-label">Email</label>
                <input type="email" id="supplierEmail" class="form-control">
              </div>
              <div class="col-12">
                <label for="supplierAddress" class="form-label">Address</label>
                <textarea id="supplierAddress" class="form-control" rows="2"></textarea>
              </div>
              <div class="col-md-6">
                <label for="paymentTerms" class="form-label">Payment Terms</label>
                <select id="paymentTerms" class="form-control">
                  <option value="Cash on Delivery">Cash on Delivery</option>
                  <option value="Net 15">Net 15</option>
                  <option value="Net 30" selected>Net 30</option>
                  <option value="Net 60">Net 60</option>
                </select>
              </div>
              <div class="col-md-6">
                <label for="supplierStatus" class="form-label">Status</label>
                <select id="supplierStatus" class="form-control">
                  <option value="active" selected>Active</option>
                  <option value="inactive">Inactive</option>
                </select>
              </div>
              <div class="col-12">
                <label for="supplierNotes" class="form-label">Notes</label>
                <textarea id="supplierNotes" class="form-control" rows="2"></textarea>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-save"></i> Save
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- âœ… FIXED: Script Loading Order (Token First) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/error-handler.js"></script>
  <script src="assets/js/utils.js"></script>
  <script src="assets/js/api-client.js"></script>
  <script src="assets/js/rbac.js"></script>
  <script src="assets/js/accessibility-fix.js"></script>
  <script src="assets/js/app-core.js"></script>

  <!-- âœ… Page-Specific Logic -->
<script>
  let supplierData = [];
  let modal;

  // Wait for Janstro initialization
  window.addEventListener('janstro:ready', async () => {
    console.log("âœ… Suppliers page ready");
    
    // Initialize Bootstrap modal
    modal = new bootstrap.Modal(document.getElementById('supplierModal'));
    
    // Check RBAC permissions
    RBAC.enforceActions('suppliers', { create: '#btnAdd' });
    
    // Load suppliers
    await loadSuppliers();
    
    // Attach event listeners
    document.getElementById('searchSupplier').addEventListener('input', filterSuppliers);
    document.getElementById('statusFilter').addEventListener('change', filterSuppliers);
  });

 async function loadSuppliers() {
    const container = document.getElementById('supplierTable');
    container.innerHTML = '<div class="text-center py-5"><div class="spinner-border"></div></div>';

    try {
        const response = await API.getSuppliers();
        
        // Handle multiple response formats
        let suppliers = [];
        if (Array.isArray(response)) {
            suppliers = response;
        } else if (response?.data && Array.isArray(response.data)) {
            suppliers = response.data;
        } else if (response?.success && Array.isArray(response.data)) {
            suppliers = response.data;
        }
        
        supplierData = suppliers;
        
        if (supplierData.length) {
            renderTable(supplierData);
        } else {
            container.innerHTML = '<div class="text-center py-4 text-muted">No suppliers found</div>';
        }
        
        updateStats();
    } catch (error) {
        console.error('Load suppliers error:', error);
        container.innerHTML = '<div class="text-center py-4 text-danger">Failed to load suppliers</div>';
    }
}

  function renderTable(data) {
    document.getElementById('supplierTable').innerHTML = `
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead>
            <tr>
              <th>Supplier</th>
              <th>Contact</th>
              <th>Phone</th>
              <th>Email</th>
              <th>Terms</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${data.map(s => `
              <tr>
                <td>
                  <strong>${Utils.sanitizeHTML(s.supplier_name)}</strong><br>
                  <small class="text-muted">${(s.address || '').substring(0, 30)}...</small>
                </td>
                <td>${Utils.sanitizeHTML(s.contact_person || '-')}</td>
                <td>${Utils.sanitizeHTML(s.phone || '-')}</td>
                <td>${Utils.sanitizeHTML(s.email || '-')}</td>
                <td><span class="badge bg-info">${Utils.sanitizeHTML(s.payment_terms || 'COD')}</span></td>
                <td><span class="badge ${s.status === 'active' ? 'bg-success' : 'bg-secondary'}">${s.status}</span></td>
                <td>
                  <button class="btn btn-sm btn-primary" onclick="editSupplier(${s.supplier_id})" aria-label="Edit">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="deleteSupplier(${s.supplier_id})" aria-label="Delete">
                    <i class="bi bi-trash"></i>
                  </button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>`;
  }

  function updateStats() {
    // âœ… FIXED: Now supplierData is ALWAYS an array
    document.getElementById('statTotal').textContent = supplierData.length;
    document.getElementById('statActive').textContent =
      supplierData.filter(s => s.status === 'active').length;
    document.getElementById('statInactive').textContent =
      supplierData.filter(s => s.status === 'inactive').length;
  }

  function filterSuppliers() {
    const search = document.getElementById('searchSupplier').value.toLowerCase();
    const status = document.getElementById('statusFilter').value;
    
    const filtered = supplierData.filter(s => {
      const matchSearch =
        (s.supplier_name?.toLowerCase().includes(search)) || 
        (s.contact_person?.toLowerCase().includes(search));
      const matchStatus = !status || s.status === status;
      return matchSearch && matchStatus;
    });
    
    renderTable(filtered);
  }

  function showAddModal() {
    document.getElementById('modalTitle').textContent = 'Add Supplier';
    document.getElementById('supplierForm').reset();
    document.getElementById('supplierId').value = '';
    modal.show();
  }

  function editSupplier(id) {
    const supplier = supplierData.find(s => s.supplier_id === id);
    if (!supplier) return;

    document.getElementById('modalTitle').textContent = 'Edit Supplier';
    document.getElementById('supplierId').value = supplier.supplier_id;
    document.getElementById('supplierName').value = supplier.supplier_name;
    document.getElementById('contactPerson').value = supplier.contact_person || '';
    document.getElementById('supplierPhone').value = supplier.phone || '';
    document.getElementById('supplierEmail').value = supplier.email || '';
    document.getElementById('supplierAddress').value = supplier.address || '';
    document.getElementById('paymentTerms').value = supplier.payment_terms || 'Net 30';
    document.getElementById('supplierStatus').value = supplier.status;
    document.getElementById('supplierNotes').value = supplier.notes || '';

    modal.show();
  }

  async function saveSupplier(event) {
    event.preventDefault();
    
    const supplierId = document.getElementById('supplierId').value;
    const data = {
      supplier_name: document.getElementById('supplierName').value,
      contact_person: document.getElementById('contactPerson').value,
      phone: document.getElementById('supplierPhone').value,
      email: document.getElementById('supplierEmail').value,
      address: document.getElementById('supplierAddress').value,
      payment_terms: document.getElementById('paymentTerms').value,
      status: document.getElementById('supplierStatus').value,
      notes: document.getElementById('supplierNotes').value
    };

    try {
      if (supplierId) {
        await API.updateSupplier(supplierId, data);
        Utils.showToast('Supplier updated successfully', 'success');
      } else {
        await API.createSupplier(data);
        Utils.showToast('Supplier created successfully', 'success');
      }

      modal.hide();
      await loadSuppliers();
    } catch (error) {
      Utils.showToast(error.message || 'Failed to save supplier', 'error');
    }
  }

  async function deleteSupplier(id) {
    if (!confirm('Are you sure you want to delete this supplier?')) return;

    try {
      await API.deleteSupplier(id);
      Utils.showToast('Supplier deleted successfully', 'success');
      await loadSuppliers();
    } catch (error) {
      Utils.showToast(error.message || 'Failed to delete supplier', 'error');
    }
  }
</script>

  <!-- âœ… MUST BE LAST: App Initialization -->
  <script src="assets/js/app-init.js"></script>
</body>
</html>